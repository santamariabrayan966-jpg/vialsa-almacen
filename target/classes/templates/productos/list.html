<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Productos | VIALSA</title>

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Estilos generales -->
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <!-- Estilos espec√≠ficos de productos -->
    <link rel="stylesheet" th:href="@{/css/productos.css}">
</head>

<body class="bg-light d-flex flex-column min-vh-100"
      th:attr="data-modal-error=${modalError}">


<div th:replace="~{fragments/header :: header}"></div>

<main class="container mt-4 flex-grow-1">

    <!-- MENSAJE FLASH -->
    <div th:if="${mensaje}" class="mb-3">
        <div class="alert alert-dismissible fade show"
             th:classappend="' alert-' + ${tipoMensaje}">
            <span th:text="${mensaje}">Mensaje</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <h2 class="fw-bold text-danger mb-0">
            <i class="bi bi-box"></i> Productos
        </h2>

        <button id="btnNuevoProducto"
                class="btn btn-primary btn-sm shadow">
            <i class="bi bi-plus-circle"></i> Nuevo
        </button>
    </div>

    <!-- BUSCADOR -->
    <div class="input-group mb-3 search-input">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="buscadorProductos" type="text" class="form-control" placeholder="Buscar...">
    </div>

    <!-- TABLA -->
    <div class="table-responsive shadow rounded bg-white p-2">
        <table class="table table-striped align-middle mb-0" id="tablaProductos">
            <thead class="table-primary text-center">
            <tr>
                <th>ID</th>
                <th>Foto</th>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Dimensiones</th>
                <th class="text-end">Precio</th>
                <th class="text-end">Stock</th>
                <th class="text-end">Stock M√≠n.</th>
                <th class="text-center">Estado</th>
                <th class="text-center">Acciones</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="p : ${productos}"
                th:classappend="${p.stockActual < p.stockMinimo} ? ' table-warning'">

            <td th:text="${p.idProducto}"></td>

                <td class="text-center">
                    <img width="40" class="rounded producto-thumb"
                         th:src="${p.foto != null} ?
                 @{/img/productos/{f}(f=${p.foto})} :
                 @{/img/productos/default.png}">
                </td>


                <td th:text="${p.codigoInterno}"></td>
                <td th:text="${p.nombreProducto}"></td>
                <td th:text="${p.dimensiones}"></td>

                <td class="text-end">
                    S/ <span th:text="${#numbers.formatDecimal(p.precioUnitario,1,2)}"></span>
                </td>

                <td class="text-end">

                    <!-- üî• STOCK BAJO -->
                    <span th:if="${p.stockActual < p.stockMinimo}"
                          class="text-danger fw-bold"
                          data-bs-toggle="tooltip"
                          th:attr="title=|Stock m√≠nimo requerido: ${p.stockMinimo}|">
        <i class="bi bi-exclamation-triangle-fill"></i>
        [[${p.stockActual}]]
    </span>

                    <!-- ‚úî STOCK OK -->
                    <span th:if="${p.stockActual >= p.stockMinimo}"
                          class="text-success fw-bold"
                          data-bs-toggle="tooltip"
                          title="Stock suficiente">
        <i class="bi bi-check-circle-fill"></i>
        [[${p.stockActual}]]
    </span>

                </td>

                <td class="text-end" th:text="${p.stockMinimo}"></td>

                <td class="text-center">
                    <span class="badge estado-badge"
                          th:attr="id=${'estado-text-' + p.idProducto}"
                          th:text="${p.idEstadoProducto == 1 ? 'Activo' : 'Inactivo'}"
                          th:classappend="${p.idEstadoProducto == 1} ? ' bg-success' : ' bg-secondary'">
                    </span>
                </td>

                <td class="text-center">
                    <div class="btn-group btn-group-sm">

                        <!-- Editar -->
                        <button type="button"
                                class="btn btn-outline-primary btn-editar"
                                th:attr="data-id=${p.idProducto}">
                            <i class="bi bi-pencil"></i>
                        </button>

                        <!-- Activar / Desactivar -->
                        <button type="button"
                                class="btn btn-outline-secondary btn-estado"
                                th:attr="data-id=${p.idProducto},data-estado=${p.idEstadoProducto},data-nombre=${p.nombreProducto}">
                            <i class="bi"
                               th:classappend="${p.idEstadoProducto == 1} ? ' bi-toggle-off' : ' bi-toggle-on'"></i>
                        </button>

                        <!-- Eliminar (usa modal de confirmaci√≥n) -->
                        <form th:action="@{|/productos/${p.idProducto}/eliminar|}"
                              method="post"
                              class="d-inline form-eliminar">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="button"
                                    class="btn btn-outline-danger btn-eliminar"
                                    th:attr="data-nombre=${p.nombreProducto}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>

                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</main>

<!-- MODAL PRODUCTO (grande) -->
<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloModalProducto">
                    Nuevo Producto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form id="formProducto" th:object="${productoForm}"
                      th:action="@{/productos}" method="post"
                      class="row g-4 needs-validation" novalidate
                      enctype="multipart/form-data">

                    <input type="hidden" th:field="*{idProducto}" id="idProducto">

                    <!-- C√≥digo interno (autogenerado) -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">C√≥digo Interno</label>
                        <input type="text" th:field="*{codigoInterno}"
                               class="form-control" id="codigoInterno" readonly>
                        <div class="form-text">
                            Se generar√° autom√°ticamente seg√∫n el tipo de producto.
                        </div>
                    </div>

                    <!-- Nombre -->
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Nombre</label>
                        <input type="text" th:field="*{nombreProducto}"
                               class="form-control" required>
                        <div class="invalid-feedback">El nombre es obligatorio.</div>
                    </div>

                    <!-- Tipo de producto -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Tipo de Producto</label>
                        <select th:field="*{idTipoProducto}"
                                onchange="generarCodigo()"
                                class="form-select" id="idTipoProducto" required>
                            <option value="">Seleccione...</option>
                            <option value="1">Aluminio</option>
                            <option value="2">Vidrio</option>
                            <option value="3">Accesorio</option>
                        </select>
                        <div class="invalid-feedback">Seleccione un tipo.</div>
                        <div class="form-text">
                            El tipo define la unidad de venta (Unidad / Plancha).
                        </div>
                    </div>

                    <!-- Unidad (auto, no editable) -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Unidad</label>
                        <select th:field="*{idUnidad}" class="form-select"
                                id="idUnidad" required disabled>
                            <option value="">Seleccione...</option>
                            <option value="2">Unidad</option>   <!-- idUnidad=2 en BD -->
                            <option value="4">Plancha</option>  <!-- idUnidad=4 en BD -->
                        </select>
                        <div class="form-text">
                            Se asigna autom√°ticamente seg√∫n el tipo (no editable).
                        </div>
                    </div>

                    <!-- Estado -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Estado</label>
                        <select th:field="*{idEstadoProducto}"
                                class="form-select" id="idEstadoProducto">
                            <option value="1">Activo</option>
                            <option value="2">Inactivo</option>
                        </select>
                    </div>

                    <!-- Dimensiones -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Dimensiones</label>
                        <input type="text" th:field="*{dimensiones}"
                               class="form-control" placeholder="Ej: 1.20 x 2.00 m">
                    </div>


                    <!-- √öltimo precio de compra (solo lectura) -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">√öltimo precio de compra</label>
                        <input type="number" class="form-control" id="ultimoPrecioCompra" readonly>

                        <!-- üî• ESTE FALTABA -->
                        <div id="precioCompraInfo" class="mt-1 text-muted small"></div>
                    </div>

                    <!-- Porcentaje de ganancia -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">% Ganancia</label>
                        <input type="number" class="form-control" id="porcentajeGanancia"
                               min="0" step="0.1" placeholder="Ej: 10">
                        <div class="form-text">Ingresa el porcentaje que deseas ganar.</div>
                    </div>

                    <!-- Precio Unitario (venta) -->
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Precio Venta (S/)</label>
                        <input type="number" th:field="*{precioUnitario}"
                               min="0" step="0.01" class="form-control" id="precioVenta" required>
                        <div class="form-text">Se calcula autom√°ticamente si ingresas un %.</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Descuento M√°ximo (S/)</label>
                        <input type="number"
                               class="form-control"
                               id="descuentoMaximo"
                               name="descuentoMaximo"
                               step="0.01"
                               min="0">
                        <small class="text-muted">No puede superar el √∫ltimo precio de compra.</small>
                    </div>



                    <!-- Stock Actual (solo lectura) -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Stock Actual</label>
                        <input type="number" th:field="*{stockActual}"
                               min="0" class="form-control" id="stockActual" readonly>
                        <div class="form-text">
                            El stock se actualiza solo con compras y ventas. No se edita aqu√≠.
                        </div>
                    </div>

                    <!-- Stock M√≠nimo (alerta) -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Stock M√≠nimo</label>
                        <input type="number" th:field="*{stockMinimo}"
                               min="0" class="form-control">
                        <div class="form-text">
                            Punto de alerta para reponer (ejemplo sugerido: 20 unidades).
                        </div>
                    </div>

                    <!-- FOTO -->
                    <div class="col-md-4 text-center">
                        <label class="form-label fw-semibold d-block">Foto</label>

                        <img id="previewImg"
                             alt="Foto producto"
                             style="max-width: 150px;"
                             th:src="${productoForm.foto != null} ?
             @{/img/productos/{f}(f=${productoForm.foto})} :
             @{/img/productos/default.png}">


                        <input type="file"
                               name="imagen"
                               class="form-control mt-2"
                               onchange="previewImagen(event)">

                    </div>


                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-success btn-lg px-4">
                            <i class="bi bi-save"></i> Guardar
                        </button>
                    </div>
                </form>

            </div>

        </div>
    </div>
</div>
<div th:if="${errorNegocio}" class="alert alert-warning alert-dismissible fade show mb-3">
    <span th:text="${errorNegocio}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- MODAL PEQUE√ëO: Activar / Desactivar -->
<div class="modal fade" id="modalEstadoProducto" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar estado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="textoEstadoProducto" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary btn-sm" id="btnConfirmarEstado">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PEQUE√ëO: Eliminar -->
<div class="modal fade" id="modalConfirmEliminar" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="textoEliminarProducto" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfirmarEliminar">
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- FALTA ESTE (AGR√âGALO) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:src="@{/js/productos.js}"></script>
<script th:src="@{/js/navbar.js}"></script>

</body>
</html>
