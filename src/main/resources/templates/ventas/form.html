<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Registrar Venta | VIALSA</title>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Select2 + Bootstrap theme -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">

    <!-- CSS del sistema -->
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link rel="stylesheet" th:href="@{/css/ventas.css}">
</head>

<body class="bg-light">


<div class="container-fluid p-3">

    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-receipt"></i> Nueva Venta
            </h5>
        </div>

        <div class="card-body">

            <!-- ====================== FORMULARIO ====================== -->
            <form th:action="${ventaForm.idVentas > 0} ?
                              @{/ventas/editar/{id}(id=${ventaForm.idVentas})} :
                              @{/ventas/guardar}"
                  th:object="${ventaForm}"
                  method="post"
                  id="ventaForm">

                <input type="hidden"
                       th:if="${ventaForm.idVentas != null and ventaForm.idVentas > 0}"
                       th:field="*{idVentas}">


                <input type="hidden" th:field="*{idCliente}" id="idCliente">
                <!-- üî• CAMPOS OCULTOS PARA CLIENTE MANUAL -->
                <input type="hidden" th:field="*{documentoCliente}" id="documentoCliente">
                <input type="hidden" th:field="*{nombreCliente}" id="nombreCliente">
                <input type="hidden" th:field="*{telefonoCliente}" id="telefonoCliente">


                <!-- ====================== CLIENTE ====================== -->
                <h6 class="section-title">Cliente</h6>

                <div class="row g-3 mb-3">

                    <div class="col-md-3">
                        <label class="form-label">DNI / RUC</label>
                        <div class="input-group">
                            <input type="text" id="cliDocumento" class="form-control" placeholder="DNI / RUC">
                            <button type="button" id="btnBuscarCliente" class="btn btn-outline-primary">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label">Nombre del Cliente</label>
                        <input type="text" id="cliNombre" class="form-control">

                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Tel√©fono</label>
                        <input type="text" id="cliTelefono" class="form-control">

                    </div>

                </div>

                <hr>

                <!-- ====================== COMPROBANTE ====================== -->
                <h6 class="section-title">Comprobante</h6>

                <div class="row g-3 mb-3">

                    <div class="col-md-4">
                        <label class="form-label">Tipo</label>
                        <select th:field="*{tipoComprobante}" id="tipoComprobante" class="form-select" required>
                            <option value="">Seleccione...</option>
                            <option value="BOLETA">Boleta</option>
                            <option value="FACTURA">Factura</option>
                            <option value="NOTA">Nota de Venta</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">N√∫mero</label>
                        <input th:field="*{nroComprobante}" id="nroComprobante" class="form-control" readonly>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Forma de Pago</label>
                        <select th:field="*{formaPago}" id="formaPago" class="form-select">
                            <option value="CONTADO">Contado</option>
                            <option value="CREDITO">Cr√©dito</option>
                        </select>
                    </div>

                </div>

                <!-- ====================== BLOQUE CR√âDITO ====================== -->
                <div id="bloqueCredito" class="credit-box d-none">
                    <h6 class="text-primary fw-bold">
                        <i class="bi bi-credit-card"></i> Venta a Cr√©dito
                    </h6>

                    <div class="row g-3 mb-2">

                        <div class="col-md-3">
                            <label class="form-label">Pago Inicial (S/)</label>
                            <input type="number" id="pagoInicial" name="pagoInicial" class="form-control" min="0" value="0">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Deuda (S/)</label>
                            <input type="text" id="deudaVenta" class="form-control fw-bold text-danger" readonly>
                        </div>

                    </div>
                </div>

                <hr>

                <!-- ====================== PRODUCTOS ====================== -->
                <h6 class="section-title">Productos</h6>

                <button type="button" id="agregarProducto" class="btn btn-success btn-sm mb-3">
                    <i class="bi bi-plus-circle"></i> Agregar Producto
                </button>

                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="tablaProductos">
                        <thead class="table-light text-center">
                        <tr>
                            <th>Producto</th>
                            <th>Unidad</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Desc.</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                        </thead>

                        <tbody id="detalleBody">

                        </tbody>

                    </table>
                </div>

                <!-- ====================== TOTALES ====================== -->
                <div class="card p-3 shadow-sm mt-4 card-totales-venta">
                    <div class="d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <strong id="lblSubtotal">S/ 0.00</strong>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span>IGV:</span>
                        <strong id="lblIgv">S/ 0.00</strong>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Total:</span>
                        <span id="lblTotal" class="fw-bold text-success">S/ 0.00</span>
                    </div>

                    <input type="hidden" th:field="*{totalVenta}" id="totalVentaInput">
                </div>
                <!-- ====================== BOTONES FINALES ====================== -->
                <div class="mt-4 d-flex justify-content-end gap-2">

                    <!-- Guardar como borrador -->
                    <button type="submit" class="btn btn-secondary" name="accion" value="BORRADOR">
                        <i class="bi bi-file-earmark"></i> Guardar como borrador
                    </button>

                    <!-- Registrar venta -->
                    <button type="submit" class="btn btn-primary" name="accion" value="REGISTRAR">
                        <i class="bi bi-save"></i> Registrar venta
                    </button>

                </div>




            </form>

        </div>
    </div>
</div>
<div id="select2-global-container"></div>


<!-- ========= JS EN ORDEN CORRECTO ========= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Select2 (JS SOLO UNA VEZ, sin CSS aqu√≠) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Tu JS final -->
<script th:src="@{/js/ventas.js}"></script>

<script>
    const cliDocumento = document.getElementById("cliDocumento");
    const cliNombre = document.getElementById("cliNombre");
    const cliTelefono = document.getElementById("cliTelefono");

    cliDocumento.addEventListener("input", () => {
        document.getElementById("documentoCliente").value = cliDocumento.value;
    });

    cliNombre.addEventListener("input", () => {
        document.getElementById("nombreCliente").value = cliNombre.value;
    });

    cliTelefono.addEventListener("input", () => {
        document.getElementById("telefonoCliente").value = cliTelefono.value;
    });
</script>


</body>
</html>
