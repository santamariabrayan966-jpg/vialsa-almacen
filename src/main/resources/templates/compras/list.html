<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Compras | VIALSA</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/theme.css}">

    <style>
        body { background-color: #f8f9fa; }
        .acciones-compra .btn {
            padding: 0.25rem 0.4rem;
            font-size: 0.8rem;
        }
        .acciones-compra i {
            font-size: 0.9rem;
        }

        /* === Tamaño y estilo del modal flotante === */
        #compraModal .modal-dialog {
            max-width: 1000px;          /* aquí haces la mini-ventana más grande o más pequeña */
        }
        #compraModal .modal-content {
            border-radius: 0.75rem;
        }
        #compraModalIframe {
            width: 100%;
            border: none;
            min-height: 75vh;          /* altura de la mini-ventana */
        }

        @media (max-width: 768px) {
            #compraModal .modal-dialog {
                max-width: 100%;
                margin: 0.5rem;
            }
            #compraModalIframe {
                min-height: 80vh;
            }
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100 bg-light">

<div th:replace="~{fragments/header :: header}"></div>

<main class="container mt-4 flex-grow-1">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h2 class="mb-0">
            <i class="bi bi-card-checklist"></i> Compras
        </h2>

        <!-- Nueva compra EN MINI-VENTANA -->
        <button type="button"
                class="btn btn-primary btn-sm"
                th:onclick="|openCompraModal('@{/compras/nueva}', 'Registrar nueva compra')|">
            <i class="bi bi-plus-circle"></i> Nueva Compra
        </button>
    </div>

    <!-- Mensajes -->
    <div th:if="${param.borrador}" class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-file-earmark"></i> Compra guardada como borrador.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.confirmada}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> Compra borrador confirmada como REGISTRADA.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.errorConfirmar}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-circle"></i> No se pudo confirmar la compra.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> ¡Compra registrada exitosamente!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> Ocurrió un error al procesar la compra.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.anulada}" class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-slash-circle"></i> Compra anulada correctamente.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.errorAnular}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-circle"></i> No se pudo anular la compra.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.eliminada}" class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-trash"></i> Compra en estado BORRADOR eliminada.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.errorEliminar}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-circle"></i> No se pudo eliminar la compra.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${msgCabeceraOk}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i>
        <span th:text="${msgCabeceraOk}">Cabecera actualizada correctamente.</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${msgCabeceraError}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-circle"></i>
        <span th:text="${msgCabeceraError}">Error al actualizar cabecera.</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle text-center mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Comprobante</th>
                        <th>Proveedor</th>
                        <th>Usuario</th>
                        <th>Moneda</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="c : ${compras}">
                        <td th:text="${c.idCompra}">1</td>

                        <td th:text="${#temporals.format(c.fechaEmision != null ? c.fechaEmision : c.fechaCompra, 'dd/MM/yyyy HH:mm')}">
                            11/11/2025 13:10
                        </td>

                        <td>
                            <span th:text="${c.tipoComprobante}">FACTURA</span><br>
                            <small th:text="${c.serie + '-' + c.numero}">F001-000123</small>
                        </td>

                        <td th:text="${c.nombreProveedor}">Proveedor</td>
                        <td th:text="${c.nombreUsuario}">Usuario</td>
                        <td th:text="${c.moneda}">PEN</td>
                        <td th:text="${#numbers.formatDecimal(c.totalCompra, 1, 2)}">0.00</td>

                        <td>
                            <span class="badge"
                                  th:classappend="${c.estado == 'ANULADA'} ? ' bg-danger' :
                                                  (${c.estado == 'PAGADA'} ? ' bg-success' :
                                                  (${c.estado == 'BORRADOR'} ? ' bg-info text-dark' : ' bg-secondary'))"
                                  th:text="${c.estado}">
                                REGISTRADA
                            </span>
                        </td>

                        <!-- Acciones -->
                        <td class="acciones-compra text-nowrap">

                            <!-- Ver DETALLE en mini-ventana -->
                            <button type="button"
                                    class="btn btn-outline-info btn-sm me-1"
                                    th:title="'Ver detalle'"
                                    th:onclick="|openCompraModal('@{/compras/detalle/{id}(id=${c.idCompra})}', 'Detalle de compra')|">
                                <i class="bi bi-eye"></i>
                            </button>

                            <!-- Editar compra COMPLETA solo BORRADOR en mini-ventana -->
                            <button type="button"
                                    class="btn btn-outline-warning btn-sm me-1"
                                    th:title="'Editar compra (BORRADOR)'"
                                    th:if="${c.estado == 'BORRADOR'}"
                                    th:onclick="|openCompraModal('@{/compras/editar/{id}(id=${c.idCompra})}', 'Editar compra')|">
                                <i class="bi bi-pencil-square"></i>
                            </button>

                            <!-- Anular (no si ANULADA) -->
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm me-1"
                                    th:title="'Anular compra'"
                                    th:if="${c.estado != 'ANULADA'}"
                                    th:onclick="|if(confirm('¿Seguro que deseas ANULAR esta compra?')) window.location.href='@{/compras/anular/{id}(id=${c.idCompra})}';|">
                                <i class="bi bi-slash-circle"></i>
                            </button>

                            <!-- Eliminar solo BORRADOR -->
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm me-1"
                                    th:title="'Eliminar (solo borrador)'"
                                    th:if="${c.estado == 'BORRADOR'}"
                                    th:onclick="|if(confirm('¿Seguro que deseas ELIMINAR esta compra en estado BORRADOR?')) window.location.href='@{/compras/eliminar/{id}(id=${c.idCompra})}';|">
                                <i class="bi bi-trash"></i>
                            </button>

                            <!-- Confirmar BORRADOR -> REGISTRADA -->
                            <button type="button"
                                    class="btn btn-outline-success btn-sm me-1"
                                    th:title="'Confirmar compra (afectar stock)'"
                                    th:if="${c.estado == 'BORRADOR'}"
                                    th:onclick="|if(confirm('¿Deseas CONFIRMAR esta compra y afectar el stock?')) window.location.href='@{/compras/confirmar/{id}(id=${c.idCompra})}';|">
                                <i class="bi bi-check2-circle"></i>
                            </button>

                            <!-- Exportar Excel -->
                            <a class="btn btn-outline-success btn-sm me-1"
                               th:title="'Exportar a Excel'"
                               th:href="@{/compras/excel/{id}(id=${c.idCompra})}">
                                <i class="bi bi-file-earmark-spreadsheet"></i>
                            </a>

                            <!-- Imprimir (nueva pestaña) -->
                            <a class="btn btn-outline-secondary btn-sm"
                               th:title="'Vista para imprimir'"
                               th:href="@{/compras/detalle/{id}(id=${c.idCompra})}"
                               target="_blank">
                                <i class="bi bi-printer"></i>
                            </a>

                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(compras)}">
                        <td colspan="9" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> No hay compras registradas.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Modal reutilizable con IFRAME -->
<div class="modal fade" id="compraModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title" id="compraModalTitle">Compras</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="compraModalIframe" title="Ventana compras"></iframe>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Abre una URL dentro del iframe del modal
    function openCompraModal(url, titulo) {
        const iframe  = document.getElementById('compraModalIframe');
        const titleEl = document.getElementById('compraModalTitle');
        const modalEl = document.getElementById('compraModal');

        titleEl.textContent = titulo || 'Compras';
        iframe.src = url;

        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

</script>


<script th:src="@{/js/navbar.js}"></script>

</body>
</html>
