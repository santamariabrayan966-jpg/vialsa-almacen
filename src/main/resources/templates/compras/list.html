<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${titulo}">Compras | VIALSA</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/theme.css}">

    <style>
        body {
            background-color: #f8f9fa;
        }

        /* Contenedor de acciones: que se adapte y haga wrap en pantallas pequeñas */
        .acciones-compra {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.25rem;
        }

        .acciones-compra .btn {
            padding: 0.25rem 0.4rem;
            font-size: 0.8rem;
            cursor: pointer;
        }

        #compraModalIframe {
            width: 100%;
            border: none;
            min-height: 75vh;
        }

        @media (max-width: 576px) {
            h2 i {
                margin-right: 0.25rem;
            }

            #compraModalIframe {
                min-height: 65vh;
            }
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100 bg-light">

<!-- HEADER -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="container mt-4 flex-grow-1">

    <!-- TÍTULO + BOTÓN NUEVA COMPRA -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h2 class="mb-0">
            <i class="bi bi-card-checklist"></i> Compras
        </h2>

        <button type="button"
                class="btn btn-primary btn-sm"
                th:onclick="|openCompraModal('@{/compras/nueva}', 'Registrar nueva compra')|">
            <i class="bi bi-plus-circle"></i> Nueva Compra
        </button>
    </div>

    <!-- BUSCADOR -->
    <div class="input-group mb-3">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="buscadorCompras"
               type="text"
               class="form-control"
               placeholder="Buscar compra, proveedor, usuario, estado...">
    </div>

    <!-- MENSAJES -->
    <div class="mb-3">
        <div th:if="${param.borrador}" class="alert alert-info py-2 mb-2">
            Compra guardada como borrador.
        </div>
        <div th:if="${param.borradorEditado}" class="alert alert-info py-2 mb-2">
            Borrador actualizado correctamente.
        </div>
        <div th:if="${param.confirmada}" class="alert alert-success py-2 mb-2">
            Compra confirmada.
        </div>
        <div th:if="${param.success}" class="alert alert-success py-2 mb-2">
            Compra registrada exitosamente.
        </div>
        <div th:if="${param.error}" class="alert alert-danger py-2 mb-2">
            Error al registrar compra.
        </div>
        <div th:if="${param.anulada}" class="alert alert-warning py-2 mb-2">
            Compra anulada.
        </div>
        <div th:if="${param.eliminada}" class="alert alert-info py-2 mb-0">
            Compra eliminada.
        </div>
    </div>

    <!-- ================================================
      TABLA DE COMPRAS
      ================================================ -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">

                <table id="tablaCompras"
                       class="table table-bordered table-hover text-center align-middle mb-0">

                    <!-- ======================= CABECERA ======================= -->
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Comprobante</th>
                        <th>Proveedor</th>
                        <th>Usuario</th>
                        <th>Moneda</th>
                        <th>Forma de Pago</th>
                        <th>Total</th>
                        <th>Deuda</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>

                    <!-- ======================= CUERPO ======================= -->
                    <tbody>

                    <!-- === FILA DINÁMICA POR CADA COMPRA === -->
                    <tr th:each="c : ${compras}">

                        <!-- ID -->
                        <td th:text="${c.idCompra}"></td>

                        <!-- Fecha de emisión o fecha de compra -->
                        <td th:text="${#temporals.format(c.fechaCompra, 'dd/MM/yyyy HH:mm')}"></td>


                        <!-- Tipo comprobante + serie y número -->
                        <td>
                            <span th:text="${c.tipoComprobante}"></span><br>
                            <small class="text-muted" th:text="${c.serie + '-' + c.numero}"></small>
                        </td>

                        <!-- Proveedor -->
                        <td th:text="${c.nombreProveedor}"></td>

                        <!-- Usuario -->
                        <td th:text="${c.nombreUsuario}"></td>

                        <!-- Moneda -->
                        <td th:text="${c.moneda}"></td>

                        <!-- ===== FORMATO VISUAL DE LA FORMA DE PAGO ===== -->
                        <td>
                        <span class="badge"
                              th:classappend="
                                ${c.formaPago == 'CREDITO'} ? 'bg-warning text-dark' :
                                (${c.formaPago == 'CONTADO'} ? 'bg-info text-dark' :
                                'bg-secondary')
                              "
                              th:text="${c.formaPago}">
                        </span>
                        </td>

                        <!-- Total compra -->
                        <td th:text="${#numbers.formatDecimal(c.totalCompra,1,2)}"></td>

                        <!-- ===== DEUDA ===== -->
                        <td>
    <span th:if="${c.formaPago == 'CREDITO'}"
          class="fw-bold"
          th:classappend="${c.deuda > 0} ? 'text-danger' : 'text-success'"
          th:text="${(c.moneda == 'USD' ? '$ ' : 'S/ ') + #numbers.formatDecimal(c.deuda,1,2)}">
</span>


                            <span th:if="${c.formaPago != 'CREDITO'}" class="text-muted">—</span>
                        </td>


                        <!-- ===== ESTADO ===== -->
                        <td>
                        <span class="badge"
                              th:classappend="
                                ${c.estado == 'PAGADA'} ? 'bg-success' :
                                (${c.estado == 'REGISTRADA'} ? 'bg-primary' :
                                (${c.estado == 'BORRADOR'} ? 'bg-secondary' :
                                (${c.estado == 'ANULADA'} ? 'bg-danger' : 'bg-dark')))
                              "
                              th:text="${c.estado}">
                        </span>
                        </td>

                        <!-- ===== ACCIONES ===== -->
                        <td class="acciones-compra">

                            <!-- Ver detalle -->
                            <button class="btn btn-outline-info btn-sm"
                                    th:onclick="|openCompraModal('@{/compras/detalle/{id}(id=${c.idCompra})}','Detalle de compra')|"
                                    title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </button>

                            <!-- Editar si está en borrador -->
                            <button class="btn btn-outline-warning btn-sm"
                                    th:if="${c.estado=='BORRADOR'}"
                                    th:onclick="|openCompraModal('@{/compras/editar/{id}(id=${c.idCompra})}','Editar compra')|"
                                    title="Editar compra">
                                <i class="bi bi-pencil-square"></i>
                            </button>

                            <!-- Anular -->
                            <button class="btn btn-outline-danger btn-sm"
                                    th:if="${c.estado!='ANULADA'}"
                                    th:onclick="|if(confirm('¿Anular compra?')) window.location.href='@{/compras/anular/{id}(id=${c.idCompra})}'|"
                                    title="Anular compra">
                                <i class="bi bi-slash-circle"></i>
                            </button>

                            <!-- Eliminar si está en borrador -->
                            <button class="btn btn-outline-danger btn-sm"
                                    th:if="${c.estado=='BORRADOR'}"
                                    th:onclick="|if(confirm('¿Eliminar compra?')) window.location.href='@{/compras/eliminar/{id}(id=${c.idCompra})}'|"
                                    title="Eliminar compra">
                                <i class="bi bi-trash"></i>
                            </button>

                            <!-- Confirmar si está en borrador -->
                            <button class="btn btn-outline-success btn-sm"
                                    th:if="${c.estado=='BORRADOR'}"
                                    th:onclick="|if(confirm('¿Confirmar compra?')) window.location.href='@{/compras/confirmar/{id}(id=${c.idCompra})}'|"
                                    title="Confirmar compra">
                                <i class="bi bi-check2-circle"></i>
                            </button>

                            <!-- Ver cuotas -->
                            <button class="btn btn-warning btn-sm"
                                    th:if="${c.numeroCuotas != null and c.numeroCuotas > 0}"
                                    th:attr="data-idcompra=${c.idCompra}, data-moneda=${c.moneda}"
                                    onclick="abrirModalCuotas(this.dataset.idcompra, this.dataset.moneda)"
                                    title="Ver cuotas">
                                <i class="bi bi-cash-stack"></i>
                            </button>



                            <!-- Recargar -->
                            <button class="btn btn-primary btn-sm"
                                    th:onclick="|window.location.reload()|"
                                    title="Recargar listado">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>

                            <!-- Imprimir -->
                            <button class="btn btn-outline-secondary btn-sm"
                                    th:onclick="|abrirModalImprimir(${c.idCompra})|"
                                    title="Imprimir compra">
                                <i class="bi bi-printer"></i>
                            </button>

                        </td>

                    </tr> <!-- FIN DEL EACH -->

                    <!-- === MENSAJE SI NO HAY COMPRAS === -->
                    <tr th:if="${#lists.isEmpty(compras)}">
                        <td colspan="11" class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i> No hay compras registradas.
                        </td>
                    </tr>

                    </tbody>
                </table>

            </div>
        </div>
    </div>


</main>

<!-- MODAL IFRAME: NUEVA / EDITAR / DETALLE -->
<div class="modal fade" id="compraModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 id="compraModalTitle" class="modal-title">Compras</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <iframe id="compraModalIframe"></iframe>
            </div>

        </div>
    </div>
</div>

<!-- MODAL CUOTAS -->
<div class="modal fade" id="modalCuotas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Cuotas de la Compra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="infoCuotas"></div>

                <div class="table-responsive mt-3">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="table-dark text-center">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Vence</th>
                            <th scope="col">Monto</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Pago</th>
                        </tr>
                        </thead>
                        <tbody id="tablaCuotas"></tbody>
                    </table>
                </div>

            </div>

        </div>
    </div>
</div>

<!-- MODAL IMPRIMIR -->
<div class="modal fade" id="modalImprimir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">Imprimir Compra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <p class="mb-3">Seleccione el formato:</p>

                <button id="btnPdf" type="button" class="btn btn-danger w-100 mb-3">
                    <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                </button>

                <button id="btnExcel" type="button" class="btn btn-success w-100">
                    <i class="bi bi-file-earmark-excel"></i> Descargar Excel
                </button>
            </div>

        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/compras.js}"></script>

<!-- JS imprimir -->
<script>
    function abrirModalImprimir(id) {
        window.compraActual = id;
        const modalImprimir = new bootstrap.Modal(document.getElementById("modalImprimir"));
        modalImprimir.show();

        document.getElementById("btnPdf").onclick = () => {
            window.location.href = `/compras/pdf/` + id;
        };
        document.getElementById("btnExcel").onclick = () => {
            window.location.href = `/compras/excel/` + id;
        };
    }
</script>

</body>
</html>
