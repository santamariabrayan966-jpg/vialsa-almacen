<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Usuarios del Sistema | VIALSA</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Tema general -->
    <link th:href="@{/css/theme.css}" rel="stylesheet">

    <!-- Estilos específicos de Usuarios -->
    <link th:href="@{/css/usuarios.css}" rel="stylesheet">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<!-- Encabezado -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- Contenido principal -->
<main class="container-fluid mt-5 px-4 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-danger m-0">
            <i class="bi bi-people"></i> Usuarios del Sistema
        </h2>

        <!-- AHORA abre el modal mini -->
        <button type="button" class="btn btn-success shadow-sm" id="btn-nuevo-usuario">
            <i class="bi bi-person-plus"></i> Nuevo Usuario
        </button>
    </div>

    <!-- Tabla de usuarios -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0 tabla-usuarios">
                <thead class="table-primary text-center">
                <tr>
                    <th>ID</th>
                    <th>Foto</th>
                    <th>Usuario</th>
                    <th>Nombre completo</th>
                    <th>Documento</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>

                <!-- Cuando hay usuarios -->
                <tbody th:if="${usuarios != null and !#lists.isEmpty(usuarios)}" class="text-center">
                <tr th:each="u : ${usuarios}">
                    <td th:text="${u.idUsuario}">1</td>

                    <!-- Foto -->
                    <td>
                        <img th:if="${u.foto != null}"
                             th:src="@{|/uploads/usuarios/${u.foto}|}"
                             alt="Foto usuario"
                             class="avatar-usuario">
                        <div th:if="${u.foto == null}"
                             class="avatar-usuario avatar-placeholder">
                            <i class="bi bi-person"></i>
                        </div>
                    </td>

                    <!-- Usuario -->
                    <td th:text="${u.nombreUsuario}">admin</td>

                    <!-- Nombre completo -->
                    <td th:text="${u.nombres + ' ' + u.apellidos}">Nombre Apellido</td>

                    <!-- Documento -->
                    <td th:text="${u.nroDocumento}">12345678</td>

                    <!-- Correo -->
                    <td th:text="${u.correo}">correo@ejemplo.com</td>

                    <!-- Teléfono -->
                    <td th:text="${u.telefono}">999999999</td>

                    <!-- Rol -->
                    <td th:text="${u.nombreRol}">Administrador</td>

                    <!-- Estado -->
                    <td>
                        <span th:if="${u.activo}" class="badge bg-success">Activo</span>
                        <span th:if="${!u.activo}" class="badge bg-secondary">Inactivo</span>
                    </td>

                    <!-- Acciones -->
                    <td>
                        <!-- Editar: abre modal grande -->
                        <button type="button"
                                class="btn btn-warning btn-sm me-1 btn-editar-usuario"
                                th:data-id-usuario="${u.idUsuario}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Editar datos del usuario">
                            <i class="bi bi-pencil-square"></i>
                        </button>

                        <!-- Activar / Desactivar -->
                        <a href="#"
                           th:if="${u.activo}"
                           th:attr="data-url=@{|/usuarios/desactivar/${u.idUsuario}|},
                                    data-username=${u.nombreUsuario}"
                           class="btn btn-outline-secondary btn-sm me-1 btn-desactivar">
                            <i class="bi bi-person-dash"></i>
                        </a>

                        <a href="#"
                           th:if="${!u.activo}"
                           th:attr="data-url=@{|/usuarios/activar/${u.idUsuario}|},
                                    data-username=${u.nombreUsuario}"
                           class="btn btn-outline-success btn-sm me-1 btn-activar">
                            <i class="bi bi-person-check"></i>
                        </a>

                        <!-- Eliminar -->
                        <a href="#"
                           th:attr="data-url=@{|/usuarios/eliminar/${u.idUsuario}|},
                                    data-username=${u.nombreUsuario}"
                           class="btn btn-danger btn-sm btn-eliminar">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
                </tbody>

                <!-- Si no hay usuarios -->
                <tbody th:if="${usuarios == null or #lists.isEmpty(usuarios)}">
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-triangle"></i>
                        No hay usuarios registrados.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- ─────────────────────────────────────────────
     MODAL NUEVO USUARIO (ancho, 2 columnas)
     ───────────────────────────────────────────── -->
<div class="modal fade" id="modalNuevoUsuario" tabindex="-1" aria-hidden="true">
    <!-- OJO: modal-lg en vez de modal-sm -->
    <div class="modal-dialog modal-dialog-centered modal-lg modal-nuevo-usuario">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i> Nuevo Usuario
                </h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form th:action="@{/usuarios/guardar}" method="post" enctype="multipart/form-data" id="form-nuevo-usuario">
                <div class="modal-body">

                    <!-- CSRF -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <!-- Foto centrada arriba -->
                    <div class="text-center mb-3">
                        <img id="nuevo-foto-preview"
                             src="/images/default-user.png"
                             alt="Foto usuario"
                             class="foto-preview mb-2">
                        <div class="mb-2 mx-auto" style="max-width: 260px;">
                            <label class="form-label fw-semibold mb-1">Foto de usuario (opcional)</label>
                            <input type="file" class="form-control form-control-sm"
                                   name="fotoFile" id="nuevo-fotoFile" accept="image/*">
                        </div>
                    </div>

                    <!-- Campos en dos columnas -->
                    <div class="row g-3">

                        <!-- Columna izquierda -->
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label class="form-label">Usuario</label>
                                <input type="text" class="form-control" name="nombreUsuario" required>
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Contraseña</label>
                                <input type="password" class="form-control" name="contrasena" required>
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Correo (opcional)</label>
                                <input type="email" class="form-control" name="correo">
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Teléfono (opcional)</label>
                                <input type="text" class="form-control" name="telefono">
                            </div>
                        </div>

                        <!-- Columna derecha -->
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label class="form-label">DNI</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control"
                                           name="nroDocumento" id="nuevo-nroDocumento">
                                    <button class="btn btn-outline-secondary"
                                            type="button" id="btn-buscar-dni-nuevo">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Puedes usar la API de DNI para completar nombres.
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Nombres</label>
                                <input type="text" class="form-control" name="nombres" id="nuevo-nombres">
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Apellidos</label>
                                <input type="text" class="form-control" name="apellidos" id="nuevo-apellidos">
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Rol</label>
                                <select class="form-select" name="idRol" required>
                                    <option value="" selected disabled>Seleccione un rol...</option>
                                    <option th:each="rol : ${roles}"
                                            th:value="${rol.idRol}"
                                            th:text="${rol.nombreRol}"></option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Estado</label>
                                <select class="form-select" name="activo">
                                    <option value="true" selected>Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </div>
                        </div>

                    </div> <!-- row -->
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check2-circle me-1"></i> Guardar
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- ─────────────────────────────────────────────
     MODAL GRANDE: EDITAR USUARIO
     ───────────────────────────────────────────── -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-person-lines-fill me-2"></i>Editar Usuario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <form th:action="@{/usuarios/actualizar}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <!-- CSRF -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <!-- ID oculto -->
                    <input type="hidden" name="idUsuario" id="edit-idUsuario">

                    <div class="row g-3">
                        <div class="col-md-4 text-center">
                            <img id="edit-foto-preview"
                                 src="/images/default-user.png"
                                 alt="Foto usuario"
                                 class="rounded-circle mb-2 foto-preview">
                            <div class="mb-3">
                                <label class="form-label">Cambiar foto</label>
                                <input type="file" class="form-control" name="fotoFile" id="edit-fotoFile"
                                       accept="image/*">
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Usuario</label>
                                    <input type="text" class="form-control"
                                           name="nombreUsuario" id="edit-nombreUsuario" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">DNI</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control"
                                               name="nroDocumento" id="edit-nroDocumento" required>
                                        <button class="btn btn-outline-secondary"
                                                type="button" id="btn-buscar-dni-edit">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Usar la API de DNI para completar datos.
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Nombres</label>
                                    <input type="text" class="form-control"
                                           name="nombres" id="edit-nombres" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Apellidos</label>
                                    <input type="text" class="form-control"
                                           name="apellidos" id="edit-apellidos" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Correo</label>
                                    <input type="email" class="form-control"
                                           name="correo" id="edit-correo">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Teléfono</label>
                                    <input type="text" class="form-control"
                                           name="telefono" id="edit-telefono">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Rol</label>
                                    <select class="form-select" name="idRol" id="edit-idRol" required>
                                        <option th:each="rol : ${roles}"
                                                th:value="${rol.idRol}"
                                                th:text="${rol.nombreRol}">
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" name="activo" id="edit-activo">
                                        <option value="true">Activo</option>
                                        <option value="false">Inactivo</option>
                                    </select>
                                </div>

                                <!-- No hay contraseña aquí -->
                            </div>
                        </div>

                    </div> <!-- row -->
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        ← Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check2-circle me-1"></i>Guardar cambios
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Pie de página -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JS de terceros -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JS propio -->
<script th:src="@{/js/app.js}"></script>
<script th:src="@{/js/usuarios.js}"></script>

</body>
</html>
