<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Clientes | Panel PRO</title>

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ICONOS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f3f4f6;
        }

        .card {
            border-radius: 14px;
        }

        .btn-action {
            width: 38px;
            height: 38px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>

<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="container py-4">

    <!-- TÃTULO + ACCIONES -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <h3 class="fw-bold m-0">
            <i class="bi bi-people-fill me-2"></i> Clientes PRO
        </h3>

        <div class="d-flex flex-wrap gap-2">

            <!-- IMPORTAR -->
            <button class="btn btn-success shadow-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#modalImportar">
                <i class="bi bi-upload"></i> Importar
            </button>

            <!-- EXPORTAR -->
            <button class="btn btn-secondary shadow-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#modalExportar">
                <i class="bi bi-download"></i> Exportar
            </button>

            <!-- NUEVO CLIENTE -->
            <button class="btn btn-primary shadow-sm"
                    onclick="abrirModalNuevoCliente()">
                <i class="bi bi-person-plus"></i> Nuevo Cliente
            </button>

        </div>
    </div>

    <!-- ESTADÃSTICAS -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h6>Total</h6>
                <div class="fw-bold fs-4" th:text="${totalClientes}">0</div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h6>Nuevos</h6>
                <div class="fw-bold fs-4" th:text="${clientesNuevos}">0</div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h6>Inactivos</h6>
                <div class="fw-bold fs-4" th:text="${clientesInactivos}">0</div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h6>VIP</h6>
                <div class="fw-bold fs-4" th:text="${clientesVip}">0</div>
            </div>
        </div>
    </div>

    <!-- BUSQUEDA + FILTROS -->
    <div class="card shadow-sm mb-3">
        <div class="card-body row g-3">

            <!-- BÃšSQUEDA -->
            <div class="col-12 col-md-6">
                <input type="text"
                       id="buscarCliente"
                       class="form-control"
                       placeholder="Buscar cliente por nombre, DNI, correo, telÃ©fono...">
            </div>

            <!-- BOTONES -->
            <div class="col-12 col-md-6 d-flex gap-2">

                <!-- FILTROS -->
                <button class="btn btn-outline-primary flex-fill"
                        data-bs-toggle="modal"
                        data-bs-target="#modalFiltros">
                    <i class="bi bi-funnel"></i> Filtros
                </button>

                <!-- VISTA -->
                <button class="btn btn-outline-dark flex-fill"
                        data-bs-toggle="modal"
                        data-bs-target="#modalVista">
                    <i class="bi bi-grid"></i> Vista
                </button>
            </div>
        </div>
    </div>

    <!-- TABLA / CARDS -->
    <div class="card shadow-sm">
        <div class="card-body table-responsive">

            <!-- FRAGMENTO TABLA -->
            <div id="tablaClientes" th:fragment="tablaClientes">

                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Foto</th>
                        <th>Nombres</th>
                        <th>DNI</th>
                        <th>Correo</th>
                        <th>TelÃ©fono</th>
                        <th>Estado</th>
                        <th>Etiquetas</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                    </thead>

                    <tbody>

                    <tr th:each="c : ${clientes}">

                        <!-- ID -->
                        <td th:text="${c.idClientes}"></td>

                        <!-- FOTO -->
                        <td>
                            <img th:src="@{${c.foto != null && c.foto != ''
    ? '/uploads/' + c.foto
    : '/images/default-user.png'}}"
                                 style="width:45px; height:45px; object-fit:cover; border-radius:50%;">

                        </td>

                        <!-- NOMBRE -->
                        <td th:text="${c.nombres + ' ' + c.apellidos}"></td>

                        <!-- DNI -->
                        <td th:text="${c.nro_documento}"></td>

                        <!-- CORREO -->
                        <td th:text="${c.correo}"></td>

                        <!-- TELÃ‰FONO -->
                        <td th:text="${c.telefono}"></td>

                        <!-- ESTADO -->
                        <td>
                            <span class="badge bg-success" th:if="${c.activo}">Activo</span>
                            <span class="badge bg-secondary" th:if="${!c.activo}">Inactivo</span>
                        </td>

                        <!-- ETIQUETAS -->
                        <td>
                <span class="badge bg-warning text-dark" th:if="${c.vip}">
                    <i class="bi bi-star-fill"></i> VIP
                </span>

                            <span class="badge bg-danger" th:if="${c.moroso}">
                    <i class="bi bi-exclamation-octagon-fill"></i> Moroso
                </span>
                        </td>

                        <!-- ACCIONES -->
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">

                                <!-- PERFIL -->
                                <button class="btn btn-info btn-action rounded-circle"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalPerfil"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-person-vcard"></i>
                                </button>

                                <!-- NOTAS -->
                                <button class="btn btn-secondary btn-action rounded-circle"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalNotas"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-journal-text"></i>
                                </button>

                                <!-- HISTORIAL -->
                                <button class="btn btn-warning btn-action rounded-circle"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalHistorial"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-clock-history"></i>
                                </button>

                                <!-- VIP -->
                                <button class="btn btn-outline-warning btn-action rounded-circle"
                                        th:if="${!c.vip}"
                                        onclick="marcarVip(this)"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-star"></i>
                                </button>

                                <button class="btn btn-warning btn-action rounded-circle"
                                        th:if="${c.vip}"
                                        onclick="quitarVip(this)"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-star-fill"></i>
                                </button>

                                <!-- MOROSO -->
                                <button class="btn btn-outline-danger btn-action rounded-circle"
                                        th:if="${!c.moroso}"
                                        onclick="marcarMoroso(this)"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-exclamation-octagon"></i>
                                </button>

                                <button class="btn btn-danger btn-action rounded-circle"
                                        th:if="${c.moroso}"
                                        onclick="quitarMoroso(this)"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-exclamation-octagon-fill"></i>
                                </button>

                                <!-- ACTUALIZACIÃ“N DE ESTADO -->
                                <button class="btn btn-outline-secondary btn-action rounded-circle"
                                        th:if="${c.activo}"
                                        onclick="desactivarCliente(this)"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-slash-circle"></i>
                                </button>

                                <button class="btn btn-success btn-action rounded-circle"
                                        th:if="${!c.activo}"
                                        onclick="activarCliente(this)"
                                        th:attr="data-id=${c.idClientes}">
                                    <i class="bi bi-check-circle"></i>
                                </button>

                                <!-- EDITAR -->
                                <button class="btn btn-primary btn-action rounded-circle"
                                        th:attr="onclick=|abrirModalEditarCliente(${c.idClientes})|">
                                    <i class="bi bi-pencil"></i>
                                </button>


                                <!-- ELIMINAR -->
                                <button class="btn btn-danger btn-action rounded-circle"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalEliminar"
                                        th:attr="data-id=${c.idClientes}, data-nombre=${c.nombres}">
                                    <i class="bi bi-trash"></i>
                                </button>

                            </div>
                        </td>

                    </tr>

                    <!-- SIN CLIENTES -->
                    <tr th:if="${#lists.isEmpty(clientes)}">
                        <td colspan="9" class="text-center py-3 text-muted">
                            <i class="bi bi-info-circle"></i> No hay clientes registrados.
                        </td>
                    </tr>

                    </tbody>
                </table>

            </div>


        </div>
    </div> <!-- /card tabla -->

</main> <!-- ðŸ‘ˆ CIERRE CORRECTO DEL MAIN ANTES DE LOS MODALES -->
<!-- ============================== -->
<!-- MODAL PERFIL DEL CLIENTE -->
<!-- ============================== -->
<div class="modal fade" id="modalPerfil" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-vcard"></i> Perfil del Cliente</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="perfilContenido">
                <div class="text-center py-3 text-muted">
                    <i class="bi bi-hourglass-split"></i> Cargando...
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL NOTAS INTERNAS -->
<!-- ============================== -->
<div class="modal fade" id="modalNotas" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">

            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-journal-text"></i> Notas Internas</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="listaNotas" class="mb-3" style="max-height:250px; overflow-y:auto;">
                </div>

                <label class="form-label">Nueva Nota:</label>
                <textarea id="nuevaNota" class="form-control" rows="3"></textarea>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-primary" onclick="guardarNota()">Guardar Nota</button>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL HISTORIAL -->
<!-- ============================== -->
<div class="modal fade" id="modalHistorial" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">

            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-clock-history"></i> Historial del Cliente</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="historialContenido" style="max-height:300px; overflow-y:auto;">
                <div class="text-center py-3 text-muted">
                    <i class="bi bi-hourglass-split"></i> Cargando...
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL CAMBIAR ESTADO -->
<!-- ============================== -->
<div class="modal fade" id="modalEstado" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-toggles"></i> Cambiar Estado</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <p id="textoEstado"></p>
            </div>

            <div class="modal-footer justify-content-center">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnCambiarEstado" class="btn btn-dark">Confirmar</button>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL IMPORTAR -->
<!-- ============================== -->
<div class="modal fade" id="modalImportar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-upload"></i> Importar Clientes</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label class="form-label">Archivo CSV o Excel:</label>
                <input type="file" id="archivoImportar" name="archivo" class="form-control">

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="importarClientes()">Importar</button>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL EXPORTAR -->
<!-- ============================== -->
<div class="modal fade" id="modalExportar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-download"></i> Exportar Clientes</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <button class="btn btn-outline-dark w-100 mb-2" onclick="exportar('excel')">
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </button>

                <button class="btn btn-outline-dark w-100 mb-2" onclick="exportar('csv')">
                    <i class="bi bi-filetype-csv"></i> Exportar CSV
                </button>

                <button class="btn btn-outline-dark w-100" onclick="exportar('pdf')">
                    <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL FILTROS -->
<!-- ============================== -->
<div class="modal fade" id="modalFiltros" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-funnel"></i> Filtros Avanzados</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <button class="btn btn-outline-primary w-100 mb-2" onclick="filtrar('vip')">
                    <i class="bi bi-star-fill"></i> VIP
                </button>

                <button class="btn btn-outline-danger w-100 mb-2" onclick="filtrar('moroso')">
                    <i class="bi bi-exclamation-octagon-fill"></i> Morosos
                </button>

                <button class="btn btn-outline-secondary w-100 mb-2" onclick="filtrar('inactivo')">
                    <i class="bi bi-slash-circle-fill"></i> Inactivos
                </button>

                <button class="btn btn-outline-success w-100 mb-2" onclick="filtrar('nuevo')">
                    <i class="bi bi-clock-history"></i> Nuevos (Ãºltimos 30 dÃ­as)
                </button>

                <button class="btn btn-dark w-100" onclick="filtrar('todos')">
                    <i class="bi bi-list"></i> Mostrar Todos
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL CAMBIAR VISTA -->
<!-- ============================== -->
<div class="modal fade" id="modalVista" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-layout-split"></i> Cambiar Vista</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <button class="btn btn-outline-dark w-100 mb-2" onclick="vistaTabla()">
                    <i class="bi bi-table"></i> Vista Tabla
                </button>

                <button class="btn btn-outline-dark w-100" onclick="vistaCards()">
                    <i class="bi bi-grid-3x3-gap"></i> Vista Cards
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ============================== -->
<!-- MODAL ELIMINAR PRO -->
<!-- ============================== -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-trash"></i> Confirmar EliminaciÃ³n</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                Â¿Eliminar al cliente <strong id="clienteNombre"></strong>?
            </div>

            <div class="modal-footer justify-content-center">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="btnConfirmarEliminar" class="btn btn-danger">Eliminar</a>
            </div>

        </div>
    </div>
</div>

<!-- MODAL FORMULARIO CLIENTE -->
<div class="modal fade" id="modalFormCliente" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tituloModalCliente">Nuevo Cliente</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="contenidoFormCliente">
                <div class="text-center py-3 text-muted">
                    <i class="bi bi-hourglass-split"></i> Cargando formulario...
                </div>
            </div>

        </div>
    </div>
</div>


<!-- ============================== -->
<!-- SCRIPTS FINALES -->
<!-- ============================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/clientes.js"></script>
<script th:src="@{/js/navbar.js}"></script>
<script th:if="${abrirModalCliente}">
    const modal = new bootstrap.Modal(document.getElementById('modalFormCliente'));
    modal.show();
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        // Si volvimos por error del servidor, cargar el formulario en el modal
        const flag = /*[[${abrirModalCliente}]]*/ false;

        if (flag) {
            fetch('/clientes/nuevo?fragmento=true') // o editar, segÃºn los datos del cliente
                .then(r => r.text())
                .then(html => {
                    document.getElementById('contenidoFormCliente').innerHTML = html;

                    const modal = new bootstrap.Modal(document.getElementById('modalFormCliente'));
                    modal.show();
                });
        }

    });
</script>


</body>
</html>
