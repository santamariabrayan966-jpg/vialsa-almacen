<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Registrar Movimiento | VIALSA</title>

    <!-- 🔹 Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- 🔹 Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-olI1n1rZBiScXpgfVq0jP8g9+LR+1AsaXbKspZfwGL0hFgu7grX4kUX1mAxW+Rm2JjHgWbY2WCP0sSibO0W3DQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body class="d-flex flex-column min-vh-100 bg-light">

<!-- ✅ Encabezado -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 📦 Contenedor principal -->
<div class="container mt-4 flex-grow-1">
    <h2 class="text-danger mb-4 fw-bold">
        <i class="fas fa-box-open"></i> Registrar Movimiento de Inventario
    </h2>

    <form th:action="@{/inventario/guardar}" th:object="${movimientoForm}" method="post" class="row g-3 shadow-sm p-4 bg-white rounded">

        <!-- Tipo de movimiento -->
        <div class="col-md-4">
            <label class="form-label fw-semibold">Tipo de Movimiento</label>
            <select th:field="*{tipoMovimiento}" class="form-select" required>
                <option value="">Selecciona...</option>
                <option value="ENTRADA">Entrada</option>
                <option value="SALIDA">Salida</option>
            </select>
        </div>

        <!-- Cantidad -->
        <div class="col-md-4">
            <label class="form-label fw-semibold">Cantidad</label>
            <input type="number" min="1" step="0.01" th:field="*{cantidad}" class="form-control"
                   placeholder="Ej. 10.00" required>
        </div>

        <!-- Producto -->
        <div class="col-md-4">
            <label class="form-label fw-semibold">Producto</label>
            <select th:field="*{idProducto}" class="form-select" required>
                <option value="">Selecciona un producto...</option>
                <option th:each="p : ${productos}" th:value="${p.idProducto}"
                        th:text="${p.nombreProducto}"></option>
            </select>
        </div>

        <!-- Unidad -->
        <div class="col-md-4">
            <label class="form-label fw-semibold">Unidad</label>
            <select th:field="*{idUnidad}" class="form-select" required>
                <option value="">Selecciona una unidad...</option>
                <option th:each="u : ${unidades}"
                        th:value="${u.idUnidad}"
                        th:text="${u.nombreUnidad}"></option>
            </select>
        </div>

        <!-- Cliente (con búsqueda por DNI/RUC y lupa) -->
        <div class="col-md-4">
            <label for="documentoCliente" class="form-label fw-semibold">Cliente (RUC o DNI)</label>
            <div class="input-group">
                <input type="text" id="documentoCliente" name="nroDocumento"
                       class="form-control" placeholder="Ingrese DNI o RUC">
                <button type="button" class="btn btn-outline-primary" id="buscarCliente" title="Buscar cliente">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>
        </div>

        <div class="col-md-4">
            <label class="form-label fw-semibold">Nombre del Cliente</label>
            <input type="text" id="nombreCliente" class="form-control" placeholder="Nombre completo" readonly>
        </div>

        <!-- Botones -->
        <div class="col-12 mt-4 text-end">
            <button type="submit" class="btn btn-success px-4">
                <i class="fa-solid fa-save"></i> Guardar
            </button>
            <a th:href="@{/inventario}" class="btn btn-secondary px-4">
                <i class="fa-solid fa-arrow-left"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<!-- ✅ Pie de página -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 🔍 Script de búsqueda de cliente -->
<script>
    async function buscarCliente() {
        const numero = document.getElementById("documentoCliente").value.trim();
        if (!numero) return alert("Ingrese un número de DNI o RUC");

        try {
            const tipo = numero.length === 8 ? "dni" : "ruc";
            const resp = await fetch(`/api/externo/${tipo}/${numero}`);
            const data = await resp.json();

            if (data.data) {
                const nombre = tipo === "dni"
                    ? (data.data.nombre_completo || data.data.nombre || "")
                    : (data.data.nombre_o_razon_social || data.data.razon_social || "");
                document.getElementById("nombreCliente").value = nombre.trim();
            } else {
                alert("No se encontraron datos del cliente.");
                document.getElementById("nombreCliente").value = "";
            }
        } catch (err) {
            console.error("❌ Error:", err);
            alert("Error al buscar el cliente.");
        }
    }

    document.getElementById("buscarCliente").addEventListener("click", buscarCliente);
    document.getElementById("documentoCliente").addEventListener("keypress", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            buscarCliente();
        }
    });
</script>

</body>
</html>
